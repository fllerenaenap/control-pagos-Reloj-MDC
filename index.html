<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Pagos del Grupo</title>
    <!-- Carga de Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la librería Chart.js para los gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Plugin para mostrar etiquetas de datos (porcentajes) en las barras y donut -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script> 
    <style>
        /* Configuración de fuente Inter para un aspecto moderno */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilo para filas de tabla al pasar el ratón */
        .member-row:hover {
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Encabezado de la Aplicación -->
        <header class="text-center py-6 mb-8 bg-white shadow-lg rounded-xl">
            <h1 class="text-4xl font-extrabold text-blue-800">📊 Control de Pagos del Grupo</h1>
            <p class="mt-2 text-xl text-gray-600">Lista actualizada, vamos por ese reloj!</p>
            <div id="loading" class="mt-4 text-blue-500 font-semibold">Cargando datos...</div>
        </header>

        <!-- Sección de Estadísticas y Gráficos -->
        <div class="grid grid-cols-1 md:grid-cols-1 gap-6 mb-8">
             <!-- Card: Resumen de Progreso -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Resumen General</h2>
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <div class="mb-4 sm:mb-0">
                        <p class="text-sm font-medium text-gray-500">Monto Esperado Total:</p>
                        <!-- El valor inicial es 0.00, se actualiza dinámicamente -->
                        <p id="expectedTotal" class="text-3xl font-extrabold text-gray-900">$0.00</p>
                    </div>
                    <div class="mb-4 sm:mb-0">
                        <p class="text-sm font-medium text-gray-500">Monto Recaudado:</p>
                        <p id="collectedTotal" class="text-3xl font-extrabold text-green-600">$0.00</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Integrantes que Faltan:</p>
                        <p id="pendingMembers" class="text-3xl font-extrabold text-red-500">0</p>
                    </div>
                </div>

                <!-- Barra de Progreso -->
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Progreso de Recaudación (Monto)</h3>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                    <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-700" style="width: 0%"></div>
                </div>
                <p id="progressPercent" class="text-right text-sm font-medium text-gray-600">0%</p>
            </div>

            <!-- Card: Gráfico de Integrantes Pagados (Doughnut) -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-teal-500 flex justify-center items-center">
                <div class="w-full h-64">
                    <canvas id="membersChart"></canvas>
                </div>
            </div>

            <!-- NUEVO: Card: Gráfico de Porcentaje por Departamentos (Barra) -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500 md:col-span-1 flex justify-center items-center">
                <div class="w-full h-80">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Progreso de Pago por Departamento</h2>
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>

        </div>

        <!-- Sección de Listado de Integrantes -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Detalle de Integrantes</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Departamento</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Pagado</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                        </tr>
                        <!-- Fila de Filtros -->
                        <tr class="bg-white border-t border-gray-200">
                            <th class="p-2">
                                <input type="text" id="filterNombre" onkeyup="filterTable()" placeholder="Filtrar nombre" class="w-full p-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                            </th>
                            <th class="p-2">
                                <input type="text" id="filterDept" onkeyup="filterTable()" placeholder="Filtrar depto." class="w-full p-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                            </th>
                            <th class="p-2 flex justify-center items-center h-full">
                                <!-- SELECT para filtrar por estado de pago (Todos/Pagado/Pendiente) -->
                                <select id="filterStatus" onchange="filterTable()" class="w-full p-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                                    <option value="all">Todos</option>
                                    <option value="paid">Pagado</option>
                                    <option value="pending">Pendiente</option>
                                </select>
                            </th>
                            <th class="p-2">
                                <div class="text-sm text-gray-400 p-1 text-right">Monto</div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="memberList" class="bg-white divide-y divide-gray-200">
                        <!-- Los datos de los Integrantes se insertarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Panel de Errores Detallado -->
        <div id="detailedErrorPanel" class="mt-8 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 hidden rounded-md shadow-md" role="alert">
            <p class="font-bold text-lg mb-2">🚨 Error Crítico de Conexión o Datos</p>
            <p id="errorMsgDisplay" class="mb-4 text-sm font-semibold">Mensaje de error.</p>
            <h3 class="font-bold text-red-800 mb-1">Pasos de Solución (CRÍTICO: Publicación de la Hoja):</h3>
            <ul class="list-disc list-inside text-sm space-y-1">
                <li><strong>1. Re-publicar la Hoja:</strong> Vuelva a su Google Sheet y vaya a **Archivo** > **Compartir** > **Publicar en la web...**.</li>
                <li><strong>2. Verificar Formato:</strong> Asegúrese de que esté configurado para la hoja correcta (generalmente la primera) y que el formato de salida sea **"Valores separados por comas (.csv)"**.</li>
                <li><strong>3. URL Usada:</strong> <code id="apiURLDisplay" class="bg-red-200 px-1 py-0.5 rounded text-xs break-all"></code></li>
            </ul>
        </div>


    </div>

    <script>
        // =========================================================================================
        // CONFIGURACIÓN Y CONSTANTES
        // =========================================================================================

        // URL de publicación CSV proporcionada por el usuario.
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTFbglTpzHvcw1Pm25nZr4OPQ7hjK2-KxJPnRHs5B4zVo7CPznzW2xAZm4qYgA1hHmj_EEs8P5LOzFH/pub?output=csv'; 
        
        // Costo fijo por miembro solicitado por el usuario.
        const COST_PER_MEMBER = 3.6; 
        
        // Almacena los datos completos de los Integrantes para el filtrado en memoria
        let membersData = [];
        let membersChartInstance = null;
        let departmentChartInstance = null; 

        // =========================================================================================
        // UTILIDADES Y LÓGICA DE DATOS
        // =========================================================================================

        // Función auxiliar para formatear montos a moneda (USD por defecto, dos decimales)
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
            }).format(amount);
        }

        // Función simple para parsear datos CSV (saltándose la primera fila/cabecera)
        function parseCSV(csvText) {
            const rows = csvText.split('\n').filter(line => line.trim() !== '');
            if (rows.length < 2) {
                 throw new Error("CSV vacío o con formato incorrecto. Asegúrese de que la hoja tenga al menos una fila de datos después del encabezado.");
            }

            // Nota: Se asume el orden de las columnas: Nombre, Dept, Pagado (TRUE/FALSE), Monto.
            const data = [];
            // Saltar la fila de cabecera (índice 0)
            for (let i = 1; i < rows.length; i++) {
                // Separación por coma. Esto es simple y puede fallar con nombres/montos que contengan comas,
                // pero es el método estándar para CSV publicados desde Google Sheets.
                const columns = rows[i].split(','); 
                
                if (columns.length >= 4) {
                    const pagadoString = columns[2].trim().toLowerCase();
                    
                    data.push({
                        nombre: columns[0].trim(),
                        dept: columns[1].trim(),
                        // Columna 2: Convertir "TRUE" o "FALSE" o "si" a booleano
                        pagado: pagadoString === 'true' || pagadoString === 'sí' || pagadoString === 'si', 
                        // Columna 3: Convertir a número (eliminar comillas si Google Sheets las añadió)
                        monto: parseFloat(columns[3].trim().replace(/"/g, '')) || 0 
                    });
                }
            }
            return data;
        }

        // Función para realizar fetch con reintentos y backoff
        async function retryFetch(url, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 404 || response.status === 403) {
                         // 404/403 (No encontrado/Permiso denegado) -> Error fatal, no reintentar
                         throw new Error(`Error HTTP: ${response.status} (${response.statusText}). La URL de publicación CSV es incorrecta o inaccesible.`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                         // Lanzar un error más descriptivo sobre la falla de red
                         throw new Error(`Error de red: Falló la conexión (Failed to fetch). Mensaje original: ${error.message}`); 
                    }
                    // Espera exponencial: 1s, 2s, 4s...
                    const delay = Math.pow(2, i) * 1000; 
                    console.warn(`Intento ${i + 1} fallido. Reintentando en ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Máximo de reintentos alcanzado. Fallo en la conexión de red.");
        }

        // Función auxiliar para mostrar el panel de errores detallado
        function displayError(message) {
            document.getElementById('loading').classList.add('hidden');
            
            const detailedErrorPanel = document.getElementById('detailedErrorPanel');
            const errorMsgDisplayElement = document.getElementById('errorMsgDisplay');
            const apiURLDisplayElement = document.getElementById('apiURLDisplay');

            errorMsgDisplayElement.textContent = message;
            apiURLDisplayElement.textContent = CSV_URL;
            detailedErrorPanel.classList.remove('hidden');
            
            console.error(`ERROR CRÍTICO: ${message}`);
        }

        // Función para calcular las estadísticas por departamento
        function calculateDepartmentStats(data) {
            const deptMap = {};
            const cost = COST_PER_MEMBER;

            data.forEach(member => {
                // Usa el valor del departamento de la hoja o 'Sin Depto' si está vacío
                const deptName = member.dept && member.dept !== '' ? member.dept : 'Sin Depto'; 
                
                if (!deptMap[deptName]) {
                    deptMap[deptName] = {
                        collected: 0,
                        expected: 0,
                        memberCount: 0
                    };
                }

                deptMap[deptName].collected += member.monto;
                deptMap[deptName].memberCount++;
                // El total esperado es fijo por cada miembro
                deptMap[deptName].expected += cost; 
            });

            const results = {
                labels: [],
                percentages: [],
                colors: []
            };

            // Paleta de colores para los departamentos
            const colorPalette = [
                '#6366f1', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#003366', '#9ca3af', '#3b82f6' 
            ];
            let colorIndex = 0;

            for (const deptName in deptMap) {
                const stats = deptMap[deptName];
                let percentage = 0;

                if (stats.expected > 0) {
                    // Calcular porcentaje recaudado vs esperado, asegurar un máximo de 100%
                    percentage = (stats.collected / stats.expected) * 100; 
                }

                results.labels.push(deptName);
                results.percentages.push(Math.min(percentage, 100).toFixed(1)); // Limitar a 100% y un decimal
                
                results.colors.push(colorPalette[colorIndex % colorPalette.length]);
                colorIndex++;
            }

            return results;
        }

        // =========================================================================================
        // RENDERIZADO Y GRÁFICOS
        // =========================================================================================

        // Función para actualizar el resumen y la barra de progreso
        function updateSummaryUI(data) {
            const totalMembers = data.length;
            const collectedTotal = data.reduce((sum, m) => sum + m.monto, 0);
            const expectedTotal = totalMembers * COST_PER_MEMBER;
            const paidMembers = data.filter(m => m.pagado).length;
            const pendingMembers = totalMembers - paidMembers;

            // Calcular el progreso porcentual (limitado a 100%)
            let progress = 0;
            if (expectedTotal > 0) {
                progress = Math.min((collectedTotal / expectedTotal) * 100, 100);
            }

            // Actualizar elementos de texto
            document.getElementById('expectedTotal').textContent = formatCurrency(expectedTotal);
            document.getElementById('collectedTotal').textContent = formatCurrency(collectedTotal);
            document.getElementById('pendingMembers').textContent = pendingMembers;

            // Actualizar barra de progreso
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${progress.toFixed(1)}%`;
            document.getElementById('progressPercent').textContent = `${progress.toFixed(1)}% Recaudado`;

            // Actualizar color de la barra
            if (progress >= 100) {
                 progressBar.classList.remove('bg-blue-600');
                 progressBar.classList.add('bg-green-600');
            } else {
                 progressBar.classList.remove('bg-green-600');
                 progressBar.classList.add('bg-blue-600');
            }

            // Inicializar/Actualizar gráficos
            initChart(paidMembers, totalMembers);
            const deptStats = calculateDepartmentStats(data);
            initDepartmentChart(deptStats);
        }

        // Función para inicializar el gráfico de Integrantes (Dona)
        function initChart(paidCount, totalCount) {
            const ctx = document.getElementById('membersChart').getContext('2d');
            
            if (membersChartInstance) {
                membersChartInstance.destroy();
            }

            membersChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pagado', 'Pendiente'],
                    datasets: [{
                        label: 'Integrantes',
                        data: [paidCount, totalCount - paidCount],
                        backgroundColor: ['#10B981', '#F59E0B'],
                        hoverOffset: 4
                    }]
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#374151' // Gray 700
                            }
                        },
                        // Usar datalabels para mostrar el porcentaje dentro del donut
                        datalabels: {
                            formatter: (value, context) => {
                                const dataset = context.chart.data.datasets[0];
                                const total = dataset.data.reduce((sum, data) => sum + data, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                return percentage;
                            },
                            color: '#fff', // Color de fuente blanco para contraste en el donut
                            font: {
                                weight: 'bold',
                                size: 14
                            }
                        }
                    }
                }
            });
        }

        // Función para inicializar el gráfico de porcentaje de departamentos (Barra)
        function initDepartmentChart(deptStats) {
            const ctx = document.getElementById('departmentChart').getContext('2d');
            
            if (departmentChartInstance) {
                departmentChartInstance.destroy();
            }

            departmentChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: deptStats.labels,
                    datasets: [{
                        label: '% de Recaudación',
                        data: deptStats.percentages,
                        backgroundColor: deptStats.colors,
                        borderColor: deptStats.colors.map(c => c.replace('500', '600')), // Un poco más oscuro
                        borderWidth: 1
                    }]
                },
                plugins: [ChartDataLabels], // Registrar el plugin de datalabels
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100, // Para dar un poco de margen al 100% y las etiquetas
                            title: {
                                display: true,
                                text: 'Porcentaje de Recaudación (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + "%";
                                }
                            }
                        },
                        x: {
                             grid: {
                                display: false
                             },
                             title: {
                                display: true,
                                text: 'Departamento'
                             }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        // Configuración de datalabels para mostrar el porcentaje sobre la barra
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value, context) {
                                // Asegurarse de que el valor se muestre como porcentaje
                                return value + '%'; 
                            },
                            color: '#1F2937', // Gray 800
                            font: {
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Función para renderizar la tabla de miembros
        function renderTable(data) {
            const memberList = document.getElementById('memberList');
            memberList.innerHTML = ''; // Limpiar la tabla

            data.forEach(member => {
                const statusText = member.pagado ? 'Pagado' : 'Pendiente';
                const statusColor = member.pagado ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const row = document.createElement('tr');
                row.className = 'member-row transition duration-150 ease-in-out';
                row.setAttribute('data-status', member.pagado ? 'paid' : 'pending');
                row.setAttribute('data-name', member.nombre.toLowerCase());
                row.setAttribute('data-dept', member.dept.toLowerCase());

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${member.nombre}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.dept || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-right">${formatCurrency(member.monto)}</td>
                `;
                memberList.appendChild(row);
            });
        }

        // Función para filtrar la tabla basada en la entrada de filtros
        function filterTable() {
            const filterNombre = document.getElementById('filterNombre').value.toLowerCase();
            const filterDept = document.getElementById('filterDept').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;
            const rows = document.getElementById('memberList').querySelectorAll('tr');

            rows.forEach(row => {
                const name = row.getAttribute('data-name');
                const dept = row.getAttribute('data-dept');
                const status = row.getAttribute('data-status');
                
                // Aplicar filtros
                const matchName = name.includes(filterNombre);
                const matchDept = dept.includes(filterDept);
                const matchStatus = filterStatus === 'all' || status === filterStatus;

                if (matchName && matchDept && matchStatus) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
        }

        // =========================================================================================
        // FUNCIÓN PRINCIPAL DE CARGA
        // =========================================================================================

        async function loadData() {
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                // 1. Obtener datos con reintentos
                const response = await retryFetch(CSV_URL);
                const csvText = await response.text();
                
                // 2. Parsear el CSV
                membersData = parseCSV(csvText);

                if (membersData.length === 0) {
                     throw new Error("La hoja de cálculo está vacía o solo contiene el encabezado. Por favor, agregue datos para empezar.");
                }

                // 3. Actualizar UI y gráficos
                updateSummaryUI(membersData);
                renderTable(membersData);

                // 4. Ocultar el indicador de carga
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('detailedErrorPanel').classList.add('hidden');

            } catch (error) {
                // Manejar cualquier error durante el fetch, parseo o renderizado
                displayError(error.message);
            }
        }

        // Iniciar la aplicación al cargar la ventana
        window.onload = loadData;
    </script>
</body>
</html>



