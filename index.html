<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Pagos del Grupo</title>
    <!-- Carga de Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la librería Chart.js para los gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Configuración de fuente Inter para un aspecto moderno */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Encabezado de la Aplicación -->
        <header class="text-center py-6 mb-8 bg-white shadow-lg rounded-xl">
            <h1 class="text-4xl font-extrabold text-blue-800">📊 Control de Pagos del Grupo</h1>
            <p class="mt-2 text-xl text-gray-600">Lista actualizada</p>
            <div id="loading" class="mt-4 text-blue-500 font-semibold hidden">Cargando datos...</div>
        </header>

        <!-- Sección de Estadísticas y Gráficos -->
        <div class="grid grid-cols-1 lg:col-span-3 gap-6 mb-8">

            <!-- Card: Resumen de Progreso -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Resumen General</h2>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div class="mb-4 md:mb-0">
                        <p class="text-sm font-medium text-gray-500">Monto Esperado Total:</p>
                        <!-- El valor inicial es 0.00, se actualiza dinámicamente -->
                        <p id="expectedTotal" class="text-3xl font-extrabold text-gray-900">$0.00</p>
                    </div>
                    <div class="mb-4 md:mb-0">
                        <p class="text-sm font-medium text-gray-500">Monto Recaudado:</p>
                        <p id="collectedTotal" class="text-3xl font-extrabold text-green-600">$0.00</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Integrantes que Faltan:</p>
                        <p id="pendingMembers" class="text-3xl font-extrabold text-red-500">0</p>
                    </div>
                </div>

                <!-- Barra de Progreso -->
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Progreso de Recaudación (Monto)</h3>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                    <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-700" style="width: 0%"></div>
                </div>
                <p id="progressPercent" class="text-right text-sm font-medium text-gray-600">0%</p>
            </div>

            <!-- Card: Gráfico de Integrantes Pagados -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-teal-500 flex justify-center items-center">
                <div class="w-full h-64">
                    <canvas id="membersChart"></canvas>
                </div>
            </div>

        </div>

        <!-- Sección de Listado de Integrantes -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Detalle de Integrantes</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Depto.</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Pagado</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                        </tr>
                        <!-- Fila de Filtros -->
                        <tr class="bg-white border-t border-gray-200">
                            <th class="p-2">
                                <input type="text" id="filterNombre" onkeyup="filterTable()" placeholder="Filtrar nombre" class="w-full p-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                            </th>
                            <th class="p-2">
                                <input type="text" id="filterDept" onkeyup="filterTable()" placeholder="Filtrar depto." class="w-full p-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                            </th>
                            <th class="p-2 flex justify-center items-center h-full">
                                <!-- CHECKBOX para mostrar solo pendientes -->
                                <div class="flex items-center space-x-2 p-1 pt-2">
                                    <input type="checkbox" id="showPendingOnly" onchange="filterTable()" class="form-checkbox h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                                    <label for="showPendingOnly" class="text-sm text-gray-700 whitespace-nowrap">Pendientes</label>
                                </div>
                            </th>
                            <th class="p-2">
                                <div class="text-sm text-gray-400 p-1 text-right">Monto</div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="memberList" class="bg-white divide-y divide-gray-200">
                        <!-- Los datos de los Integrantes se insertarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Panel de Errores Detallado -->
        <div id="detailedErrorPanel" class="mt-8 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 hidden rounded-md shadow-md" role="alert">
            <p class="font-bold text-lg mb-2">🚨 Error Crítico de Conexión: Error HTTP (404)</p>
            <p id="errorMsgDisplay" class="mb-4 text-sm font-semibold">Este error significa que la URL de publicación CSV está inactiva o ha cambiado. Vuelva a publicarla para obtener la URL correcta y actualícela en la constante CSV_URL.</p>
            <h3 class="font-bold text-red-800 mb-1">Pasos de Solución (CRÍTICO: Publicación de la Hoja):</h3>
            <ul class="list-disc list-inside text-sm space-y-1">
                <li><strong>1. Re-publicar la Hoja:</strong> Vuelva a su Google Sheet y vaya a **Archivo** > **Compartir** > **Publicar en la web...**.</li>
                <li><strong>2. Verificar Formato:</strong> Asegúrese de que esté configurado para la hoja correcta (generalmente la primera) y que el formato de salida sea **"Valores separados por comas (.csv)"**.</li>
                <li><strong>3. Obtener Nueva URL y Compartirla:</strong> Una vez que la republique, Google generará una URL activa. Si es diferente a la que ve abajo, <strong>por favor, compártala</strong> para que pueda actualizar la constante `CSV_URL` en este código.</li>
                <li><strong>4. URL Usada:</strong> <code id="apiURLDisplay" class="bg-red-200 px-1 py-0.5 rounded text-xs break-all">https://docs.google.com/spreadsheets/d/e/2PACX-1vTFbglTpzHvcw1Pm25nZr4OPQ7hjK2-KxJPnRHs5B4zVo7CPznzW2xAZm4qYgA1hHmj_EEs8P5LOzFH/pub?gid=0&single=true&output=csv</code></li>
            </ul>
        </div>


    </div>

    <script>
        // Configuración de la aplicación
        // URL de publicación CSV proporcionada por el usuario
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTFbglTpzHvcw1Pm25nZr4OPQ7hjK2-KxJPnRHs5B4zVo7CPznzW2xAZm4qYgA1hHmj_EEs8P5LOzFH/pub?output=csv'; 
        
        // Costo fijo por miembro solicitado por el usuario.
        const COST_PER_MEMBER = 3.6; 
        
        // Almacena los datos completos de los Integrantes para el filtrado en memoria
        let membersData = [];
        let membersChartInstance = null;


        // Función simple para parsear datos CSV (saltándose la primera fila/cabecera)
        function parseCSV(csvText) {
            const rows = csvText.split('\n').filter(line => line.trim() !== '');
            if (rows.length < 2) return []; // Necesita cabecera y al menos una fila de datos

            const data = [];
            // Saltar la fila de cabecera (índice 0)
            for (let i = 1; i < rows.length; i++) {
                // Separación simple por coma
                const columns = rows[i].split(','); 
                
                if (columns.length >= 4) {
                    const pagadoString = columns[2].trim().toLowerCase();
                    
                    data.push({
                        nombre: columns[0].trim(),
                        dept: columns[1].trim(),
                        // Columna 2: Convertir "TRUE" o "FALSE" a booleano
                        pagado: pagadoString === 'true' || pagadoString === 'sí' || pagadoString === 'si', 
                        // Columna 3: Convertir a número (puede tener comillas si el monto es formatado en Google Sheets)
                        monto: parseFloat(columns[3].trim().replace(/"/g, '')) || 0 
                    });
                }
            }
            return data;
        }

        // Función para realizar fetch con reintentos y backoff
        async function retryFetch(url, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 404 || response.status === 403) {
                         // 404/403 (No encontrado/Permiso denegado) -> Error fatal, no reintentar
                         throw new Error(`Error HTTP: ${response.status} (${response.statusText}). La URL de publicación CSV es incorrecta, inaccesible o fue despublicada.`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        // Lanzar un error más descriptivo sobre la falla de red
                        throw new Error(`Error de red: Falló la conexión (Failed to fetch). Posibles causas: CORS, conexión de red inestable o bloqueo por el entorno. Mensaje original: ${error.message}`); 
                    }
                    // Espera exponencial: 1s, 2s, 4s...
                    const delay = Math.pow(2, i) * 1000; 
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Máximo de reintentos alcanzado. Fallo en la conexión de red.");
        }


        // Función auxiliar para mostrar errores
        function displayError(message) {
            document.getElementById('loading').classList.add('hidden');
            
            const detailedErrorPanel = document.getElementById('detailedErrorPanel');
            const errorMsgDisplayElement = document.getElementById('errorMsgDisplay');
            const apiURLDisplayElement = document.getElementById('apiURLDisplay');

            errorMsgDisplayElement.textContent = message;
            apiURLDisplayElement.textContent = CSV_URL;
            detailedErrorPanel.classList.remove('hidden');
            
            console.error(`ERROR DE CONEXIÓN O PROCESAMIENTO: ${message}`);
        }

        // Función para inicializar el gráfico de Integrantes
        function initChart(paidCount, totalCount) {
            const ctx = document.getElementById('membersChart').getContext('2d');
            
            if (membersChartInstance) {
                membersChartInstance.destroy();
            }

            membersChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pagado', 'Pendiente'],
                    datasets: [{
                        label: 'Integrantes',
                        data: [paidCount, totalCount - paidCount],
                        backgroundColor: ['#10B981', '#F59E0B'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#4B5563',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Estado de Pagos (${totalCount} Integrantes)`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            color: '#1F2937'
                        }
                    }
                }
            });
        }

        // Función para renderizar la tabla con los datos filtrados/completos
        function renderTable(data) {
            let memberListHTML = '';
            const memberListElement = document.getElementById('memberList');
            
            if (data.length === 0) {
                memberListElement.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">
                            No se encontraron Integrantes que coincidan con los filtros o no se encontraron datos válidos.
                        </td>
                    </tr>
                `;
                return;
            }

            data.forEach((member, index) => {
                const statusIcon = member.pagado 
                    ? '<span class="text-green-500 font-bold">✓</span>' 
                    : '<span class="text-red-500 font-bold">✗</span>';
                const statusText = member.pagado ? 'Sí' : 'No';
                const statusColor = member.pagado ? 'text-green-600' : 'text-red-500';

                memberListHTML += `
                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${member.nombre}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.dept}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm ${statusColor}">
                            ${statusIcon} ${statusText}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-gray-900">
                            $${member.monto.toFixed(2)}
                        </td>
                    </tr>
                `;
            });
            memberListElement.innerHTML = memberListHTML;
        }

        // Función para filtrar los datos de los Integrantes
        function filterTable() {
            const filterNombre = document.getElementById('filterNombre').value.toLowerCase();
            const filterDept = document.getElementById('filterDept').value.toLowerCase();
            // Obtener el estado del checkbox
            const showPendingOnly = document.getElementById('showPendingOnly').checked; 

            const filteredData = membersData.filter(member => {
                const matchesNombre = member.nombre.toLowerCase().includes(filterNombre);
                const matchesDept = member.dept.toLowerCase().includes(filterDept);

                let matchesPagado = true;
                
                // Si el checkbox "Pendientes" está marcado, solo mostramos a quienes NO han pagado.
                if (showPendingOnly) {
                    matchesPagado = !member.pagado; // true si member.pagado es false (Pendiente)
                }

                return matchesNombre && matchesDept && matchesPagado;
            });

            renderTable(filteredData);
        }


        // Función principal para cargar datos y renderizar
        async function fetchDataAndRender() {
            document.getElementById('detailedErrorPanel').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                // 1. Obtener los datos CSV
                const response = await retryFetch(CSV_URL);
                const csvText = await response.text();

                // 2. Parsear los datos CSV a la estructura de Integrantes
                membersData = parseCSV(csvText);

                if (membersData.length === 0) {
                     throw new Error("No se pudo parsear datos o la hoja está vacía. Verifique la estructura de columnas.");
                }

                // 3. Calcular totales
                let paidMembersCount = 0;
                let totalCollected = 0;
                const totalMembers = membersData.length;
                
                // CÁLCULO DINÁMICO del total esperado
                const expectedTotalCalculated = totalMembers * COST_PER_MEMBER;

                membersData.forEach((member) => {
                    totalCollected += member.monto;
                    if (member.pagado) {
                        paidMembersCount++;
                    }
                });

                // Cálculos finales y actualización de la UI
                const pendingMembersCount = totalMembers - paidMembersCount;
                // Usar el total esperado calculado para el progreso
                const collectionProgress = (totalCollected / expectedTotalCalculated) * 100;
                
                // 4. Actualizar Estadísticas
                // El monto esperado se actualiza con el valor calculado
                document.getElementById('expectedTotal').textContent = `$${expectedTotalCalculated.toFixed(2)}`;
                document.getElementById('collectedTotal').textContent = `$${totalCollected.toFixed(2)}`;
                document.getElementById('pendingMembers').textContent = pendingMembersCount;
                
                // 5. Actualizar Barra de Progreso
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = `${Math.min(collectionProgress, 100).toFixed(0)}%`;
                progressBar.className = `bg-blue-600 h-4 rounded-full transition-all duration-700 ${collectionProgress >= 100 ? 'bg-green-600' : 'bg-blue-600'}`;
                // El porcentaje de progreso también usa el total esperado calculado
                document.getElementById('progressPercent').textContent = `${collectionProgress.toFixed(2)}% de $${expectedTotalCalculated.toFixed(2)}`;
                
                // 6. Renderizar Gráfico
                initChart(paidMembersCount, totalMembers);

                // 7. Renderizar Lista de Integrantes (Usando la data completa inicialmente)
                renderTable(membersData);

                document.getElementById('loading').classList.add('hidden');

            } catch (error) {
                displayError(`Error al obtener o procesar datos CSV: ${error.message}`);
            }
        }

        // Hacemos la función filterTable accesible globalmente
        window.filterTable = filterTable; 

        // Ejecutar la función al cargar la ventana
        window.onload = fetchDataAndRender;
    </script>
</body>
</html>
