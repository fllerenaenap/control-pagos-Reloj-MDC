<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Pagos del Grupo</title>
    <!-- Carga de Tailwind CSS para el dise침o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la librer칤a Chart.js para los gr치ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
     <!-- NUEVA L칈NEA: Plugin para mostrar etiquetas de datos (porcentajes) en las barras -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script> 
    <style>
        /* Configuraci칩n de fuente Inter para un aspecto moderno */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Encabezado de la Aplicaci칩n -->
        <header class="text-center py-6 mb-8 bg-white shadow-lg rounded-xl">
            <h1 class="text-4xl font-extrabold text-blue-800">游늵 Control de Pagos del Grupo</h1>
            <p class="mt-2 text-xl text-gray-600">Lista actualizada, vamos por ese reloj!</p>
            <div id="loading" class="mt-4 text-blue-500 font-semibold hidden">Cargando datos...</div>
        </header>

        <!-- Secci칩n de Estad칤sticas y Gr치ficos -->
        <div class="grid grid-cols-1 gap-6 mb-8">  <!-- CAMBIO: Siempre 1 columna, uno debajo del otro -->

            <!-- Card: Resumen de Progreso -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Resumen General</h2>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div class="mb-4 md:mb-0">
                        <p class="text-sm font-medium text-gray-500">Monto Esperado Total:</p>
                        <!-- El valor inicial es 0.00, se actualiza din치micamente -->
                        <p id="expectedTotal" class="text-3xl font-extrabold text-gray-900">$0.00</p>
                    </div>
                    <div class="mb-4 md:mb-0">
                        <p class="text-sm font-medium text-gray-500">Monto Recaudado:</p>
                        <p id="collectedTotal" class="text-3xl font-extrabold text-green-600">$0.00</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Integrantes que Faltan:</p>
                        <p id="pendingMembers" class="text-3xl font-extrabold text-red-500">0</p>
                    </div>
                </div>

                <!-- Barra de Progreso -->
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Progreso de Recaudaci칩n (Monto)</h3>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                    <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-700" style="width: 0%"></div>
                </div>
                <p id="progressPercent" class="text-right text-sm font-medium text-gray-600">0%</p>
            </div>

            <!-- Card: Gr치fico de Integrantes Pagados -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-teal-500 flex justify-center items-center">
                <div class="w-full h-64">
                    <canvas id="membersChart"></canvas>
                </div>
            </div>

            <!-- NUEVO: Card: Gr치fico de Porcentaje por Departamentos -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500 flex justify-center items-center">
                <div class="w-full h-64">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>

        </div>

        <!-- Secci칩n de Listado de Integrantes -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Detalle de Integrantes</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>

                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Pagado</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                        </tr>
                        <!-- Fila de Filtros -->
                        <tr class="bg-white border-t border-gray-200">
                            <th class="p-2">
                                <input type="text" id="filterNombre" onkeyup="filterTable()" placeholder="Filtrar nombre" class="w-full p-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                            </th>

                            <th class="p-2 flex justify-center items-center h-full">
                                <!-- SELECT para filtrar por estado de pago (Todos/Pagado/Pendiente) -->
                                <select id="filterStatus" onchange="filterTable()" class="w-full p-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                                    <option value="all">Todos</option>
                                    <option value="paid">Pagado</option>
                                    <option value="pending">Pendiente</option>
                                </select>
                            </th>
                            <th class="p-2">
                                <div class="text-sm text-gray-400 p-1 text-right">Monto</div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="memberList" class="bg-white divide-y divide-gray-200">
                        <!-- Los datos de los Integrantes se insertar치n aqu칤 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Panel de Errores Detallado -->
        <div id="detailedErrorPanel" class="mt-8 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 hidden rounded-md shadow-md" role="alert">
            <p class="font-bold text-lg mb-2">游뚿 Error Cr칤tico de Conexi칩n: Error HTTP (404)</p>
            <p id="errorMsgDisplay" class="mb-4 text-sm font-semibold">Este error significa que la URL de publicaci칩n CSV est치 inactiva o ha cambiado. Vuelva a publicarla para obtener la URL correcta y actual칤cela en la constante CSV_URL.</p>
            <h3 class="font-bold text-red-800 mb-1">Pasos de Soluci칩n (CR칈TICO: Publicaci칩n de la Hoja):</h3>
            <ul class="list-disc list-inside text-sm space-y-1">
                <li><strong>1. Re-publicar la Hoja:</strong> Vuelva a su Google Sheet y vaya a **Archivo** > **Compartir** > **Publicar en la web...**.</li>
                <li><strong>2. Verificar Formato:</strong> Aseg칰rese de que est칠 configurado para la hoja correcta (generalmente la primera) y que el formato de salida sea **"Valores separados por comas (.csv)"**.</li>
                <li><strong>3. Obtener Nueva URL y Compartirla:</strong> Una vez que la republique, Google generar치 una URL activa. Si es diferente a la que ve abajo, <strong>por favor, comp치rtala</strong> para que pueda actualizar la constante `CSV_URL` en este c칩digo.</li>
                <li><strong>4. URL Usada:</strong> <code id="apiURLDisplay" class="bg-red-200 px-1 py-0.5 rounded text-xs break-all">https://docs.google.com/spreadsheets/d/e/2PACX-1vTFbglTpzHvcw1Pm25nZr4OPQ7hjK2-KxJPnRHs5B4zVo7CPznzW2xAZm4qYgA1hHmj_EEs8P5LOzFH/pub?gid=0&single=true&output=csv</code></li>
            </ul>
        </div>


    </div>

    <script>
        // Configuraci칩n de la aplicaci칩n
        // URL de publicaci칩n CSV proporcionada por el usuario
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTFbglTpzHvcw1Pm25nZr4OPQ7hjK2-KxJPnRHs5B4zVo7CPznzW2xAZm4qYgA1hHmj_EEs8P5LOzFH/pub?output=csv'; 
        
        // Costo fijo por miembro solicitado por el usuario.
        const COST_PER_MEMBER = 3.6; 
        
        // Almacena los datos completos de los Integrantes para el filtrado en memoria
        let membersData = [];
        let membersChartInstance = null;
        let departmentChartInstance = null;  // NUEVO: Instancia para el gr치fico de departamentos

        // Funci칩n simple para parsear datos CSV (salt치ndose la primera fila/cabecera)
        function parseCSV(csvText) {
            const rows = csvText.split('\n').filter(line => line.trim() !== '');
            if (rows.length < 2) return []; // Necesita cabecera y al menos una fila de datos

            const data = [];
            // Saltar la fila de cabecera (칤ndice 0)
            for (let i = 1; i < rows.length; i++) {
                // Separaci칩n simple por coma
                const columns = rows[i].split(','); 
                
                if (columns.length >= 4) {
                    const pagadoString = columns[2].trim().toLowerCase();
                    
                    data.push({
                        nombre: columns[0].trim(),
                        dept: columns[1].trim(),
                        // Columna 2: Convertir "TRUE" o "FALSE" a booleano
                        pagado: pagadoString === 'true' || pagadoString === 's칤' || pagadoString === 'si', 
                        // Columna 3: Convertir a n칰mero (puede tener comillas si el monto es formatado en Google Sheets)
                        monto: parseFloat(columns[3].trim().replace(/"/g, '')) || 0 
                    });
                }
            }
            return data;
        }

        // Funci칩n para realizar fetch con reintentos y backoff
        async function retryFetch(url, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 404 || response.status === 403) {
                         // 404/403 (No encontrado/Permiso denegado) -> Error fatal, no reintentar
                         throw new Error(`Error HTTP: ${response.status} (${response.statusText}). La URL de publicaci칩n CSV es incorrecta, inaccesible o fue despublicada.`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        // Lanzar un error m치s descriptivo sobre la falla de red
                        throw new Error(`Error de red: Fall칩 la conexi칩n (Failed to fetch). Posibles causas: CORS, conexi칩n de red inestable o bloqueo por el entorno. Mensaje original: ${error.message}`); 
                    }
                    // Espera exponencial: 1s, 2s, 4s...
                    const delay = Math.pow(2, i) * 1000; 
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("M치ximo de reintentos alcanzado. Fallo en la conexi칩n de red.");
        }

        // Funci칩n auxiliar para mostrar errores
        function displayError(message) {
            document.getElementById('loading').classList.add('hidden');
            
            const detailedErrorPanel = document.getElementById('detailedErrorPanel');
            const errorMsgDisplayElement = document.getElementById('errorMsgDisplay');
            const apiURLDisplayElement = document.getElementById('apiURLDisplay');

            errorMsgDisplayElement.textContent = message;
            apiURLDisplayElement.textContent = CSV_URL;
            detailedErrorPanel.classList.remove('hidden');
            
            console.error(`ERROR DE CONEXI칍N O PROCESAMIENTO: ${message}`);
        }

        // Funci칩n para calcular las estad칤sticas por departamento
        function calculateDepartmentStats(data) {
            const deptMap = {};

            data.forEach(member => {
                // Usa el valor del departamento de la hoja o 'Sin Depto' si est치 vac칤o
                const deptName = member.dept && member.dept !== '' ? member.dept : 'Sin Depto'; 
                
                if (!deptMap[deptName]) {
                    deptMap[deptName] = {
                        collected: 0,
                        expected: 0,
                        memberCount: 0
                    };
                }

                deptMap[deptName].collected += member.monto;
                deptMap[deptName].memberCount++;
                // El total esperado es fijo por cada miembro
                deptMap[deptName].expected += COST_PER_MEMBER; 
            });

            const results = {
                labels: [],
                percentages: [],
                colors: []
            };

            // Paleta de colores para los departamentos (hasta 6-7 colores)
            const colorPalette = [
                '#6366f1', // Indigo 500
                '#10b981', // Emerald 500
                '#f59e0b', // Amber 500
                '#ef4444', // Red 500
                '#06b6d4', // Cyan 500
                '#a855f7', // Purple 500
                '#9ca3af'  // Gray 400 (para 'Sin Depto')
            ];
            let colorIndex = 0;

            for (const deptName in deptMap) {
                const stats = deptMap[deptName];
                let percentage = 0;

                if (stats.expected > 0) {
                     // Calcular porcentaje recaudado vs esperado
                    percentage = (stats.collected / stats.expected) * 100; 
                }

                results.labels.push(deptName);
                results.percentages.push(Math.min(percentage, 100).toFixed(1)); // Limitar a 100% y un decimal
                
                results.colors.push(colorPalette[colorIndex % colorPalette.length]);
                colorIndex++;
            }

            return results;
        }

        // Funci칩n para inicializar el gr치fico de porcentaje de departamentos
        function initDepartmentChart(deptStats) {
            const ctx = document.getElementById('departmentChart').getContext('2d');
            
            if (departmentChartInstance) {
                departmentChartInstance.destroy();
            }

            departmentChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: deptStats.labels,
                    datasets: [{
                        label: '% de Recaudaci칩n',
                        data: deptStats.percentages,
                        backgroundColor: deptStats.colors,
                        borderColor: deptStats.colors,
                        borderWidth: 1
                    }]
                },
                plugins: [ChartDataLabels], // Registrar el plugin de datalabels
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Porcentaje (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Departamento'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        // Configuraci칩n de datalabels para mostrar el porcentaje sobre la barra
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value, context) {
                                // Asegurarse de que el valor se muestre como porcentaje
                                return value + '%'; 
                            },
                            color: '#4B5563', 
                            font: {
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Funci칩n para inicializar el gr치fico de Integrantes
        function initChart(paidCount, totalCount) {
            const ctx = document.getElementById('membersChart').getContext('2d');
            
            if (membersChartInstance) {
                membersChartInstance.destroy();
            }

            membersChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pagado', 'Pendiente'],
                    datasets: [{
                        label: 'Integrantes',
                        data: [paidCount, totalCount - paidCount],
                        backgroundColor: ['#10B981', '#F59E0B'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#
